{% macro arch() -%}
{% set arch_map = {'x86_64': 'amd64', 'aarch64': 'arm64'} -%}
{{ arch_map.get(grains['cpuarch'], 'amd64') }}
{%- endmacro %}

{% macro install_binary(name) -%}
# extract artifact tarball to /opt/endpoints/{{name}}
extract-{{name}}:
  archive.extracted:
    - name: /opt/endpoints/{{name}}
    - source: /tmp/artifacts/{{name}}_linux_{{ arch() }}.tar.gz
    - enforce_toplevel: False
    - require:
      - cmd: verify-artifacts

/opt/endpoints/{{name}}/server:
  file.managed:
    - source: /opt/endpoints/{{name}}/{{name}}_linux_{{ arch() }}
    - mode: '0755'
    - user: {{name}}
    - group: {{name}}
{%- endmacro %}

{% macro envfile(name, port, log_dir) -%}
/etc/default/{{name}}:
  file.managed:
    - source: salt://roles/endpoints/templates/endpoint.env.j2
    - template: jinja
    - context: { port: {{port}}, log_dir: "{{log_dir}}", name: "{{name}}" }
{%- endmacro %}

{% macro unitfile(name, user, port) -%}
/etc/systemd/system/{{name}}.service:
  file.managed:
    - source: salt://roles/endpoints/templates/endpoint.service.j2
    - template: jinja
    - context: { name: "{{name}}", user: "{{user}}", port: {{port}} }
    - watch_in:
      - cmd: systemctl-daemon-reload
{%- endmacro %}
